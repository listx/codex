<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Codex</title>
<meta name="author" content="Linus Arver" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="syntax-highlighting.css"/>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">Codex</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h-Introduction">1. Introduction</a></li>
<li><a href="#h-Layout">2. Layout</a></li>
<li><a href="#h-Literate-Programming-Build-System">3. Literate Programming Build System</a>
<ul>
<li><a href="#h-Overview-of-how-LP-is-used-in-this-project">3.1. Overview of how LP is used in this project</a>
<ul>
<li><a href="#h-Source-code-blocks--monoblocks-and-polyblocks">3.1.1. Source code blocks: monoblocks and polyblocks</a></li>
</ul>
</li>
<li><a href="#h-Weaving--generating-the-docs">3.2. Weaving (generating the docs)</a>
<ul>
<li><a href="#h-Emacs-customizations-for-HTML-export--codex-el">3.2.1. Emacs customizations for HTML export (codex.el)</a>
<ul>
<li><a href="#h-Toplevel-publishing-function---codex-publish-">3.2.1.1. Toplevel publishing function (<code>codex-publish</code>)</a>
<ul>
<li><a href="#h-Modify-the-Org-buffer">3.2.1.1.1. Modify the Org buffer</a></li>
<li><a href="#h-Modify-the-HTML">3.2.1.1.2. Modify the HTML</a></li>
<li><a href="#h-Miscellaneous-export-settings">3.2.1.1.3. Miscellaneous export settings</a></li>
</ul>
</li>
<li><a href="#h-Org-modifications">3.2.1.2. Org modifications</a>
<ul>
<li><a href="#h-Smart-source-code-block-captions">3.2.1.2.1. Smart source code block captions</a></li>
<li><a href="#h-Human-readable-UIDs--Headings--aka-headlines">3.2.1.2.2. Human-readable UIDs (Headings, aka headlines)</a></li>
<li><a href="#h-Give-polyblocks-a----name-------field--HTML-ID">3.2.1.2.3. Give polyblocks a <code>#+name: ...</code> field (HTML ID)</a></li>
</ul>
</li>
<li><a href="#h-HTML-modifications">3.2.1.3. HTML modifications</a>
<ul>
<li><a href="#h-Use-human-readable-HTML-IDs-for-source-code-links">3.2.1.3.1. Use human-readable HTML IDs for source code links</a></li>
<li><a href="#h-Pretty-source-code-captions">3.2.1.3.2. Pretty source code captions</a></li>
<li><a href="#h-Link-noweb-references--link-to-child-block-from-parent-block">3.2.1.3.3. Link noweb references (link to child block from parent block)</a></li>
</ul>
</li>
<li><a href="#h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks">3.2.1.4. Autogenerate CSS for syntax highlighting of source code blocks</a></li>
<li><a href="#h-Fix-non-determinism">3.2.1.5. Fix non-determinism</a>
<ul>
<li><a href="#h-Do-not-insert-current-time-as-HTML-comment">3.2.1.5.1. Do not insert current time as HTML comment</a></li>
<li><a href="#h-Do-not-insert-current-Org-mode-version">3.2.1.5.2. Do not insert current Org mode version</a></li>
<li><a href="#h-Do-not-use-random-numbers-for-the-HTML--id--attribute">3.2.1.5.3. Do not use random numbers for the HTML "id" attribute</a></li>
</ul>
</li>
<li><a href="#h-Misc-settings">3.2.1.6. Misc settings</a>
<ul>
<li><a href="#h-Use-HTML5-export--not-XML--to-un-break-MathJax">3.2.1.6.1. Use HTML5 export, not XML (to un-break MathJax)</a></li>
<li><a href="#h-move-this-bit-into-a-snippet-that-s-autoloaded-upon-opening-up-this-org-file--and-any-other-org-file-that-we-use">3.2.1.6.2. <span class="todo TODO">TODO</span> move this bit into a snippet that's autoloaded upon opening up this org file (and any other org file that we use)</a></li>
</ul>
</li>
<li><a href="#h-Imports">3.2.1.7. Imports</a></li>
<li><a href="#h-Performance-optimizations">3.2.1.8. Performance optimizations</a>
<ul>
<li><a href="#h-Profiling">3.2.1.8.1. Profiling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-Additional--hand-tweaked--CSS">3.2.2. Additional (hand-tweaked) CSS</a>
<ul>
<li><a href="#h-Source-code-block-body">3.2.2.1. Source code block body</a></li>
<li><a href="#h-Source-code-block-captions">3.2.2.2. Source code block captions</a></li>
<li><a href="#h-Links-to-child-source-block-from-parent">3.2.2.3. Links to child source block from parent</a></li>
</ul>
</li>
<li><a href="#h-Diagrams">3.2.3. Diagrams</a></li>
<li><a href="#h-Ignore-woven-HTML-from--git-diff">3.2.4. Ignore woven HTML from <code>git diff</code></a>
<ul>
<li><a href="#h-git-add--p">3.2.4.1. <code>git add -p</code></a></li>
</ul>
</li>
<li><a href="#h-gitignore">3.2.5. gitignore</a></li>
</ul>
</li>
<li><a href="#h-Tangling--generating-the-source-code">3.3. Tangling (generating the source code)</a></li>
<li><a href="#h-Development-environment--Nix-shell">3.4. Development environment (Nix shell)</a></li>
<li><a href="#h-Glossary">3.5. Glossary</a></li>
</ul>
</li>
<li><a href="#h-References">4. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-h-Introduction" class="outline-2">
<h2 id="h-Introduction"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-h-Introduction">
<p>
This project aims to capture my notes for studying various programming problems (data structures and algorithms).
</p>
</div>
</div>

<div id="outline-container-h-Layout" class="outline-2">
<h2 id="h-Layout"><span class="section-number-2">2.</span> Layout</h2>
<div class="outline-text-2" id="text-h-Layout">
<p>
Every problem gets its own <code>.org</code> file. The solutions are all in Python. All solutions are "standalone" in that none of them use any libraries other than what's provided by Python's standard libraries.
</p>

<p>
Below is a table of every problem, with tags that give a brief description of each one.
</p>

<table border="2" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Tags</th>
<th scope="col" class="org-left">Sources</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="problem/parity/README.html">Parity</a></td>
<td class="org-left">bitwise</td>
<td class="org-left"><a href="#citeproc_bib_item_1">[1, p. 27]</a>, <a href="#citeproc_bib_item_2">[2, p. 96]</a></td>
</tr>

<tr>
<td class="org-left"><a href="problem/rectangle_overlap/README.html">Rectangle overlap</a></td>
<td class="org-left">geometry</td>
<td class="org-left"><a href="#citeproc_bib_item_1">[1, p. 39]</a></td>
</tr>

<tr>
<td class="org-left"><a href="problem/rearrange_list_even_odd/README.html">Rearrange list</a></td>
<td class="org-left">array, partitioning</td>
<td class="org-left"><a href="#citeproc_bib_item_1">[1, p. 41]</a></td>
</tr>

<tr>
<td class="org-left"><a href="problem/dutch_national_flag/README.html">Dutch national flag</a></td>
<td class="org-left">array, partitioning</td>
<td class="org-left"><a href="#citeproc_bib_item_1">[1, p. 43]</a></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-h-Literate-Programming-Build-System" class="outline-2">
<h2 id="h-Literate-Programming-Build-System"><span class="section-number-2">3.</span> Literate Programming Build System</h2>
<div class="outline-text-2" id="text-h-Literate-Programming-Build-System">
</div>

<div id="outline-container-h-Overview-of-how-LP-is-used-in-this-project" class="outline-3">
<h3 id="h-Overview-of-how-LP-is-used-in-this-project"><span class="section-number-3">3.1.</span> Overview of how LP is used in this project</h3>
<div class="outline-text-3" id="text-h-Overview-of-how-LP-is-used-in-this-project">
<p>
Codex is written with <a href="https://en.wikipedia.org/wiki/Literate_programming">Literate Programming</a> (LP) and uses it for both the executables and libraries. All source code is generated by "tangling" the <code>*.org</code> (Org) files and these Org files act as the source of truth. Tangling is done by loading these files into Emacs and then running some <code>org-mode</code> functions. These Org files are also the source of truth for all HTML documentation (what you are reading now), and similarly the HTML is generated by invoking some functions from <code>org-mode</code>. The outputs of both tangling and weaving are checked into version control.
</p>

<p>
The vast majority of software projects do not use LP, for various reasons. This project is in part an experiment to see just how valid (or invalid) those reasons are.
</p>
</div>

<div id="outline-container-h-Source-code-blocks--monoblocks-and-polyblocks" class="outline-4">
<h4 id="h-Source-code-blocks--monoblocks-and-polyblocks"><span class="section-number-4">3.1.1.</span> Source code blocks: monoblocks and polyblocks</h4>
<div class="outline-text-4" id="text-h-Source-code-blocks--monoblocks-and-polyblocks">
<p>
We use noweb-style references, in the form <code>&lt;&lt;foo&gt;&gt;</code>, in source code blocks to delegate source code bits to other blocks. In the example below, the <code>parent-block</code> refers to 2 other child blocks for its definition.
</p>

<div class="org-src-container"><pre class="src src-org"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div><p>
This example illustrates the two ways to define a child block: either as a single code block with <code>#+name: NAME</code>, or as multiple blocks with <code>#+header: :noweb-ref NAME</code>.  In this doc, we call them <a href="#org0000000">monoblocks</a> and <a href="#org0000002">polyblocks</a> respectively. Polyblocks are concatenated together in the order they appear in the overall Org file; this final concatenated version is what gets inserted into the noweb reference in the parent block.
</p>
</div>
</div>
</div>

<div id="outline-container-h-Weaving--generating-the-docs" class="outline-3">
<h3 id="h-Weaving--generating-the-docs"><span class="section-number-3">3.2.</span> Weaving (generating the docs)</h3>
<div class="outline-text-3" id="text-h-Weaving--generating-the-docs">
<p>
Weaving is conceptually simpler than tangling because there is no extra step &#x2014; the output is an HTML page and that is something that we can use directly (unlike program source code, which may require additional compilation into a binary, depending on the language). We also limit ourselves to only HTML for simplicity (in particular, we don't have to worry about page breaks).
</p>

<p>
Weaving for requires the following dependencies:
</p>

<table border="2" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Dependency</th>
<th scope="col" class="org-left">Why</th>
<th scope="col" class="org-left">How to install it</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GNU Make</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">?</td>
</tr>

<tr>
<td class="org-left">emacs</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">texlive</td>
<td class="org-left">Diagrams</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">pdf2svg</td>
<td class="org-left">Diagrams</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">inkscape</td>
<td class="org-left">Diagrams</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
For Codex, we have a top-level <code>Makefile</code> so that we can run some <code>make</code> commands on the command line (instead of needing to invoke emacs directly).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-makefile" id="code-Makefile--code"><span class="org-variable-name">PROJ_ROOT</span> := $(<span class="org-variable-name">shell</span> git rev-parse --show-toplevel)
<span class="org-variable-name">PROCS</span> := $(<span class="org-variable-name">shell</span> nproc)
define run_emacs
        emacs $(<span class="org-variable-name">2</span>) --quick --batch --kill --load $(<span class="org-variable-name">PROJ_ROOT</span>)/codex.el --eval=<span class="org-string">"$(</span><span class="org-string"><span class="org-variable-name">1</span></span><span class="org-string">)"</span>
endef
<span class="org-variable-name">src</span> = $(<span class="org-variable-name">shell</span> find problem/ -type f -name <span class="org-string">'*.org'</span>)
<span class="org-variable-name">woven_html</span> = $(<span class="org-variable-name">patsubst</span> problem/%.org, problem/%.html, $(<span class="org-variable-name">src</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">problem/foo problem/bar ...</span>
<span class="org-variable-name">problem_dirs</span> = $(<span class="org-variable-name">shell</span> find problem -maxdepth 1 -type d | sort | tail -n+2)
<span class="org-comment-delimiter"># </span><span class="org-comment">foo bar ...</span>
<span class="org-variable-name">problem_dirs_without_prefix</span> = $(<span class="org-variable-name">subst</span> problem/,,$(<span class="org-variable-name">problem_dirs</span>))

define weave_org

<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">1</span></span><span class="org-makefile-targets">)</span>: $(<span class="org-variable-name">2</span>) build-literate.org
        <span class="org-type">@</span><span class="org-makefile-shell">echo weaving $(</span><span class="org-makefile-shell"><span class="org-variable-name">2</span></span><span class="org-makefile-shell">)</span>
        $(<span class="org-variable-name">call</span> run_emacs,(codex-publish),$(<span class="org-variable-name">2</span>))

endef

<span class="org-makefile-targets">all</span>: tangle weave
<span class="org-makefile-targets">.PHONY</span>: all

<span class="codex-child-link-from-parent"><a href="#__NREF__Makefile-tangle">Makefile-tangle</a></span>

<span class="org-makefile-targets">weave</span>: build-html

<span class="org-makefile-targets">build-html</span>: README.html $(<span class="org-variable-name">woven_html</span>)
<span class="org-makefile-targets">.PHONY</span>: build-html

<span class="org-makefile-targets">README.html</span>: build-literate.org README.org
        $(<span class="org-variable-name">call</span> run_emacs,(batch-org-gen-css-and-exit \"README.org\"),)
        $(<span class="org-variable-name">call</span> run_emacs,(codex-publish),README.org)
        sed -i <span class="org-string">'s/.csl-left-margin{float: left; padding-right: 1em/.csl-left-margin{float: left; padding-right: 1em/'</span> README.html

$(<span class="org-variable-name">foreach</span> p,$(<span class="org-variable-name">problem_dirs_without_prefix</span>),$(<span class="org-variable-name">eval</span> $(<span class="org-variable-name">call</span> weave_org,problem/$(<span class="org-variable-name">p</span>)/README.html,problem/$(<span class="org-variable-name">p</span>)/README.org)))

<span class="org-makefile-targets">test</span>: all
        python -m unittest discover -s problem
<span class="org-makefile-targets">.PHONY</span>: test

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter development environment.</span>
<span class="org-makefile-targets">shell</span>:
        nix-shell --pure
</pre></div><div class="codex-caption"></div></div>
</div>

<div id="outline-container-h-Emacs-customizations-for-HTML-export--codex-el" class="outline-4">
<h4 id="h-Emacs-customizations-for-HTML-export--codex-el"><span class="section-number-4">3.2.1.</span> Emacs customizations for HTML export (codex.el)</h4>
<div class="outline-text-4" id="text-h-Emacs-customizations-for-HTML-export--codex-el">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="code-codex-el--code"><span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-performance-optimization">codex_dot_el-performance-optimization</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-imports">codex_dot_el-imports</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-fix-nondeterminism">codex_dot_el-fix-nondeterminism</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-codex-publish">codex_dot_el-codex-publish</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-autogenerate-css">codex_dot_el-autogenerate-css</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-misc">codex_dot_el-misc</a></span>
</pre></div><div class="codex-caption"></div></div>
</div>

<div id="outline-container-h-Toplevel-publishing-function---codex-publish-" class="outline-5">
<h5 id="h-Toplevel-publishing-function---codex-publish-"><span class="section-number-5">3.2.1.1.</span> Toplevel publishing function (<code>codex-publish</code>)</h5>
<div class="outline-text-5" id="text-h-Toplevel-publishing-function---codex-publish-">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-codex-publish"><span class="org-comment-delimiter">; </span><span class="org-comment">This optimization can be used to crudely speed up weaving time by disabling fontification (no syntax highlighting of source code blocks).</span>
(<span class="org-keyword">if</span> (getenv <span class="org-string">"CODEX_LP_QUICK"</span>)
    (<span class="org-keyword">progn</span>
      (message <span class="org-string">"CODEX_LP_QUICK set; invoking some cost-cutting measures"</span>)
      (advice-add 'org-html-fontify-code <span class="org-builtin">:around</span> #'codex-disable-syntax-highlighting)))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-publish</span> ()
  (<span class="org-keyword">interactive</span>)
  (codex-publish-1)
  (codex-publish-2))

<span class="org-comment-delimiter">;; </span><span class="org-comment">This is here solely to populate the codex-child-HTML_ID-hash-table.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">codex-publish-1</span> ()
  (<span class="org-keyword">let</span> (
        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-modify-org">codex-publish-modify-org</a></span>

        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-modify-HTML-1">codex-publish-modify-HTML-1</a></span>

        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-use-css">codex-publish-use-css</a></span>)
    (org-html-export-to-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-publish-2</span> ()
  (<span class="org-keyword">let</span> (
        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-modify-org">codex-publish-modify-org</a></span>

        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-modify-HTML-2">codex-publish-modify-HTML-2</a></span>

        <span class="codex-child-link-from-parent"><a href="#__NREF__codex-publish-use-css">codex-publish-use-css</a></span>)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Debugging</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(message "codex-child-HTML_ID-hash-table: %s" codex-child-HTML_ID-hash-table)</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(message "codex-org_id-human_id-hash-table: %s" codex-org_id-human_id-hash-table)</span>
    (org-html-export-to-html)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Modify Org buffer</span>
<span class="codex-child-link-from-parent"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__UID-for-all-headlines">UID-for-all-headlines</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__UID-for-all-polyblocks">UID-for-all-polyblocks</a></span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Modify HTML</span>
<span class="codex-child-link-from-parent"><a href="#__NREF__codex-html-filter-src-blocks">codex-html-filter-src-blocks</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-prettify-source-code-captions">codex-prettify-source-code-captions</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-human-readable-src-block-ids">codex-human-readable-src-block-ids</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-codex-publish</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-codex-publish">&#x1f517;</a></span></div></div>
</div>

<div id="outline-container-h-Modify-the-Org-buffer" class="outline-6">
<h6 id="h-Modify-the-Org-buffer"><span class="section-number-6">3.2.1.1.1.</span> Modify the Org buffer</h6>
<div class="outline-text-6" id="text-h-Modify-the-Org-buffer">
<p>
Here we modify the Org mode buffer, by using <code>org-export-before-parsing-hook</code>. This takes a list of functions that are free to modify the Org mode buffer before each Org element in the buffer gets converted into HTML. For now we just give it a single function, <code>codex-link-child-src-blocks-to-parents</code>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-publish-modify-org">(org-export-before-parsing-hook
 '(codex-smart-source-code-block-captions
   codex-UID-for-all-headlines
   codex-UID-for-all-polyblocks))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-publish-modify-org</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-publish-modify-org">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Modify-the-HTML" class="outline-6">
<h6 id="h-Modify-the-HTML"><span class="section-number-6">3.2.1.1.2.</span> Modify the HTML</h6>
<div class="outline-text-6" id="text-h-Modify-the-HTML">
<p>
Here we modify the final HTML. This is useful for adding in final tweaks to the HTML that is difficult to accomplish at the Org-mode buffer level.
</p>

<p>
Phase 1: In the first phase, we use the generated HTML data to populate the <code>child-HTML_ID-hash-table</code>. This data structure is used to link to child blocks from parent blocks.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-publish-modify-HTML-1">(org-export-filter-src-block-functions
 '(codex-populate-child-HTML_ID-hash-table
   codex-populate-org_id-human_id-hash-table))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-publish-modify-HTML-1</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-publish-modify-HTML-1">&#x1f517;</a></span></div></div><p>
Phase 2: In this phase we perform the linking from parent blocks to child blocks.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-publish-modify-HTML-2">(org-export-filter-src-block-functions
 '(codex-link-to-children-from-parent-body
   codex-prettify-source-code-captions))
(org-export-filter-final-output-functions
 '(codex-replace-ord_ids-with-human_ids))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-publish-modify-HTML-2</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-publish-modify-HTML-2">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Miscellaneous-export-settings" class="outline-6">
<h6 id="h-Miscellaneous-export-settings"><span class="section-number-6">3.2.1.1.3.</span> Miscellaneous export settings</h6>
<div class="outline-text-6" id="text-h-Miscellaneous-export-settings">
<p>
Do not hardcode colors into the HTML. Instead refer to CSS class names, to be stylized by an external CSS file.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-publish-use-css">(org-html-htmlize-output-type 'css)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-publish-use-css</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-publish-use-css">&#x1f517;</a></span></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Org-modifications" class="outline-5">
<h5 id="h-Org-modifications"><span class="section-number-5">3.2.1.2.</span> Org modifications</h5>
<div class="outline-text-5" id="text-h-Org-modifications">
</div>

<div id="outline-container-h-Smart-source-code-block-captions" class="outline-6">
<h6 id="h-Smart-source-code-block-captions"><span class="section-number-6">3.2.1.2.1.</span> Smart source code block captions</h6>
<div class="outline-text-6" id="text-h-Smart-source-code-block-captions">
<p>
We want every source code block to have a caption (<code>#+caption: ...</code>) to have the following items:
</p>

<ol class="org-ol">
<li><a href="#coderef-SCB_NAME" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_NAME');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_NAME');"><code>SCB_NAME</code></a>: name of the source code block,</li>
<li><a href="#coderef-SCB_POLYBLOCK_INDICATOR" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_POLYBLOCK_INDICATOR');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_POLYBLOCK_INDICATOR');"><code>SCB_POLYBLOCK_INDICATOR</code></a>: an indicator to show whether this block is broken up over multiple blocks, and</li>
<li><a href="#coderef-SCB_LINK_TO_PARENT" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_LINK_TO_PARENT');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_LINK_TO_PARENT');"><code>SCB_LINK_TO_PARENT</code></a>: a link back up to a parent block (if any) where this block is used.</li>
</ol>

<p>
Adding these rudimentary items to the caption areas by hand for every source code block would be prohibitively tedious and error-prone. And so, we automate it with some Emacs lisp!
</p>

<p>
What we want to do is, loop through every source code block and insert a (<code>#+caption: ...</code>) text into the buffer. This modified buffer is what is sent down the pipeline for final export to HTML (i.e., the buffer modification does not affect the actual buffer (<code>*.org</code> file)).
</p>

<p>
So assume that we already have the smart captions in a sorted <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Association-Lists.html">association list</a> (aka alist), where the KEY is the integer buffer position where this caption should be inserted, and the VALUE is the caption itself (a string), like this:
</p>

<div class="org-src-container"><pre class="src src-elisp">'((153  . <span class="org-string">"#+caption: ..."</span>)
  (384  . <span class="org-string">"#+caption: ..."</span>)
  (555  . <span class="org-string">"#+caption: ..."</span>)
  (684  . <span class="org-string">"#+caption: ..."</span>)
  (1051 . <span class="org-string">"#+caption: ..."</span>))
</pre></div><p>
We can use the KEY to go to that buffer position and insert the caption. However the insertion operation mutates the buffer. This means if we perform the insertions top-to-bottom, the subsequent KEY values will become obsolete. The trick then is to just do the insertions in reverse order (bottom-to-top), so that the remaining KEY values remain valid. This is what we do below, where <code>smart-captions</code> is an alist like the one just described.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-smart-source-code-block-captions</span> (_backend)
  (<span class="org-keyword">let*</span> ((parent-blocks
           <span class="codex-child-link-from-parent"><a href="#__NREF__parent-blocks">parent-blocks</a></span>)
         (child-parent-hash-table
           <span class="codex-child-link-from-parent"><a href="#__NREF__child-parent-hash-table">child-parent-hash-table</a></span>)
         (all-src-blocks
           <span class="codex-child-link-from-parent"><a href="#__NREF__all-src-blocks">all-src-blocks</a></span>)
         (smart-captions
           <span class="codex-child-link-from-parent"><a href="#__NREF__smart-captions">smart-captions</a></span>))
    (<span class="org-keyword">cl-loop</span> for smart-caption in (reverse smart-captions) do
      (<span class="org-keyword">let</span> ((pos (car smart-caption))
            (caption (cdr smart-caption)))
        (goto-char pos)
        (insert caption)))))

<span class="codex-child-link-from-parent"><a href="#__NREF__smart-source-code-block-captions-helpers">smart-source-code-block-captions-helpers</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">smart-source-code-block-captions</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions">&#x1f517;</a></span></div></div><p>
(We'll get to the helper functions <code>__NREF__smart-source-code-block-captions-helpers</code> later as they obscure the big picture.)
</p>

<p>
Now we just have to construct <code>smart-captions</code>. The main difficulty is the construction of <a href="#coderef-SCB_LINK_TO_PARENT" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_LINK_TO_PARENT');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_LINK_TO_PARENT');"><code>SCB_LINK_TO_PARENT</code></a>, so most of the code will be concerned about child-parent associations.
</p>

<p>
Why do we even need these source code blocks to link back to their parents? The point is to make things easier to navigate. For example, if we have
</p>

<div class="org-src-container"><pre class="src src-org"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div><p>
and we export this to HTML, ideally we would want both <code>child-block-1</code> and each of the <code>child-block-2</code> blocks to include an HTML link back up to <code>parent-block</code>. This would make it easier to skim the document and not get too lost (any time you are looking at any particular source code block, you would be able to just click on the lank back to the parent (if there is one) to see a higher-level view).
</p>

<p>
The key idea here is to build a hash table (<code>child-parent-hash-table</code>) where the KEY is a child source code block and the VALUE is the parent block. Then in order to construct <a href="#coderef-SCB_LINK_TO_PARENT" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_LINK_TO_PARENT');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_LINK_TO_PARENT');"><code>SCB_LINK_TO_PARENT</code></a> we just do a lookup against this hash table to find the parent (if any).
</p>

<p>
Th first thing we need is a list of parent source code blocks. We consider a source code block a parent block if it has any noweb references within its body.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__parent-blocks"><span class="org-comment-delimiter">;; </span><span class="org-comment">parent-blocks is a let* binding, not a function call.</span>
(org-element-map (org-element-parse-buffer) 'src-block
  (<span class="org-keyword">lambda</span> (src-block)
     (<span class="org-keyword">if</span> (codex-is-parent-block src-block) src-block)))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">parent-blocks</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__parent-blocks">&#x1f517;</a></span></div></div><p>
Then we construct the <code>child-parent-hash-table</code>. For each parent block, we get all of its children (<code>child-names</code>), and use this data to construct a child-parent association:
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__child-parent-hash-table">(<span class="org-keyword">let</span> ((hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal)))
  (mapc
   (<span class="org-keyword">lambda</span> (parent-block)
    (<span class="org-keyword">let*</span> ((parent-name (org-element-property <span class="org-builtin">:name</span> parent-block))
           (parent-body (org-element-property <span class="org-builtin">:value</span> parent-block))
           (child-names (codex-get-noweb-children parent-body)))
      (mapc (<span class="org-keyword">lambda</span> (child-name) (puthash child-name parent-name hash-table)) child-names)))
   parent-blocks)
  hash-table)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">child-parent-hash-table</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__child-parent-hash-table">&#x1f517;</a></span></div></div><div class="org-src-container"><pre class="src src-emacs-lisp">(make-hash-table <span class="org-builtin">:test</span> 'equal)
(apply 'make-hash-table '<span class="org-builtin">:test</span> 'equal
  (mapcan (<span class="org-keyword">lambda</span> (parent-name)
            (mapcan (<span class="org-keyword">lambda</span> (child-name) (list child-name 1)) '('c1 'c2 'c3))) <span class="org-warning">'(p1 p2)))</span>
</pre></div><p>
Now that we have the child-parent associations, we have to look at all source code blocks and check if
</p>

<ol class="org-ol">
<li>this source code block's name shows up at all in <code>child-parent-hash-table</code>, and if so</li>
<li>add a link to the parent.</li>
</ol>

<p>
Note that a child source block can have two ways of defining its name. The first is with the direct <code>#+name: NAME</code> line, and the second way is with a line like <code>"#+header: :noweb-ref NAME"</code>.
</p>

<p>
Let's grab all source code blocks:
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__all-src-blocks">(org-element-map (org-element-parse-buffer) 'src-block 'identity)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__UID-for-all-polyblocks">all-src-blocks</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__all-src-blocks">&#x1f517;</a></span></div></div><p>
And now we can finally construct <code>smart-captions</code>:
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__smart-captions">(-remove 'null
  (<span class="org-keyword">cl-loop</span> for src-block in all-src-blocks collect
    (<span class="org-keyword">let*</span> ((child (codex-get-src-block-name src-block))
           (child-name (car child))
<span id="coderef-SCB_NAME" class="coderef-off">           (SCB_NAME (format <span class="org-string">"=%s= "</span> child-name))</span>
<span id="coderef-SCB_POLYBLOCK_INDICATOR" class="coderef-off">           (SCB_POLYBLOCK_INDICATOR (car (cdr child)))</span>
           (parent (gethash child-name child-parent-hash-table))
           (pos (org-element-property <span class="org-builtin">:begin</span> src-block))
<span id="coderef-SCB_LINK_TO_PARENT" class="coderef-off">           (SCB_LINK_TO_PARENT</span>
            (<span class="org-keyword">if</span> parent (format <span class="org-string">" [[%s][PARENT]]"</span> parent) <span class="org-string">""</span>))
           (smart-caption
            (concat
              <span class="org-string">"#+caption: "</span>
              SCB_NAME
              SCB_POLYBLOCK_INDICATOR
              SCB_LINK_TO_PARENT
              <span class="org-string">"\n"</span>)))
      (<span class="org-keyword">when</span> parent (cons pos smart-caption)))))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-captions</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__smart-captions">&#x1f517;</a></span></div></div><p>
We used some helper functions up in <a href="#__NREF__smart-source-code-block-captions"><code>__NREF__smart-source-code-block-captions</code></a>; let's examine them now.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__smart-source-code-block-captions-helpers"><span class="codex-child-link-from-parent"><a href="#__NREF__codex-is-parent-block">codex-is-parent-block</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-get-noweb-children">codex-get-noweb-children</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-get-noweb-ref-name">codex-get-noweb-ref-name</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-get-src-block-name">codex-get-src-block-name</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions">smart-source-code-block-captions-helpers</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__smart-source-code-block-captions-helpers">&#x1f517;</a></span></div></div><p>
<code>codex-is-parent-block</code> checks whether a source code block is a parent (contains noweb references to other child blocks in the form <code>__NREF__child-name</code>).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-is-parent-block">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-is-parent-block</span> (src-block)
  (<span class="org-keyword">let</span> ((body (org-element-property <span class="org-builtin">:value</span> src-block)))
    (codex-get-noweb-children body)))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions-helpers">codex-is-parent-block</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-is-parent-block">&#x1f517;</a></span></div></div><p>
<code>codex-get-noweb-children</code> extracts all noweb references in the form "<code>&lt;&lt;NAME&gt;&gt;</code>" from a given multiline string, returning a list of all such NAMEs. This function expects at most 1 noweb reference per line. The return type is a list of strings.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-get-noweb-children">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-noweb-children</span> (s)
  (<span class="org-keyword">let*</span> ((lines (split-string s <span class="org-string">"\n"</span>))
         (refs (-remove 'null
                 (mapcar
                  (<span class="org-keyword">lambda</span> (line)
                   (<span class="org-keyword">if</span> (string-match (codex-nref-rx nil) line)
                       (match-string-no-properties 1 line)))
                  lines))))
    refs))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions-helpers">codex-get-noweb-children</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-get-noweb-children">&#x1f517;</a></span></div></div><p>
<code>codex-get-noweb-ref-name</code> gets the string <code>FOO</code> in a <code>#+header: :noweb-ref FOO</code> line for a source code block.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-get-noweb-ref-name">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-noweb-ref-name</span> (source-code-block)
  (<span class="org-keyword">let*</span> ((headers (org-element-property <span class="org-builtin">:header</span> source-code-block))
         (noweb-ref-name
          (nth 0
           (-remove 'null
            (mapcar
             (<span class="org-keyword">lambda</span> (header)
               (<span class="org-keyword">if</span> (string-match <span class="org-string">":noweb-ref </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> header)
                   (match-string-no-properties 1 header)))
             headers)))))
    noweb-ref-name))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions-helpers">codex-get-noweb-ref-name</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-get-noweb-ref-name">&#x1f517;</a></span></div></div><p>
<code>codex-get-src-block-name</code> grabs the name of a (child) source code block. A child block can either be named directly with the <code>#+name: NAME</code> line, or indirectly with <code>#+header: noweb-ref NAME</code> (as we saw with <code>codex-get-noweb-ref-name</code>). We save the direct/indirect information as string, and this is used as the <a href="#coderef-SCB_POLYBLOCK_INDICATOR" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-SCB_POLYBLOCK_INDICATOR');" onmouseout="CodeHighlightOff(this, 'coderef-SCB_POLYBLOCK_INDICATOR');"><code>SCB_POLYBLOCK_INDICATOR</code></a>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-get-src-block-name">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-src-block-name</span> (src-block)
  (<span class="org-keyword">let*</span> ((name-direct (org-element-property <span class="org-builtin">:name</span> src-block))
         (name-indirect (codex-get-noweb-ref-name src-block)))
    (<span class="org-keyword">if</span> name-direct
        `(,name-direct <span class="org-string">""</span>)
        `(,name-indirect <span class="org-string">"(polyblock)"</span>))))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__smart-source-code-block-captions-helpers">codex-get-src-block-name</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-get-src-block-name">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Human-readable-UIDs--Headings--aka-headlines" class="outline-6">
<h6 id="h-Human-readable-UIDs--Headings--aka-headlines"><span class="section-number-6">3.2.1.2.2.</span> Human-readable UIDs (Headings, aka headlines)</h6>
<div class="outline-text-6" id="text-h-Human-readable-UIDs--Headings--aka-headlines">
<p>
We want all headings to have HTML IDs that are patterned after their text. This way we can have IDs like <code>some-heading-name-1</code> (where the trailing <code>-1</code> is only used to disambiguate against another heading of the same name) instead of <code>org00000a1</code>.
</p>

<p>
For each heading, we insert a <code>CUSTOM_ID</code> property which takes precedence over the <code>org...</code> IDs. We append this headline property just below every headline we find in the buffer. The actual construction of the <code>CUSTOM_ID</code> (<code>headline-UID</code> in the code below) is done by <code>codex-get-unique-id</code>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__UID-for-all-headlines">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-UID-for-all-headlines</span> (_backend)
  (<span class="org-keyword">let*</span> ((all-headlines
           (org-element-map (org-element-parse-buffer) 'headline 'identity))

         (headline-uid-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))
         (headline-UIDs
           (-remove 'null
             (<span class="org-keyword">cl-loop</span> for headline in all-headlines collect
               (<span class="org-keyword">let*</span> ((headline-UID (codex-get-unique-id headline headline-uid-hash-table))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Get the position just after the headline (just underneath it).</span>
                      (pos (<span class="org-keyword">progn</span>
                             (goto-char (org-element-property <span class="org-builtin">:begin</span> headline))
                             (re-search-forward <span class="org-string">"\n"</span>))))
                 (cons pos (concat
                            <span class="org-string">":PROPERTIES:\n"</span>
                            <span class="org-string">":CUSTOM_ID: "</span> headline-UID <span class="org-string">"\n"</span>
                            <span class="org-string">":END:\n"</span>)))))))
    <span class="org-comment-delimiter">; </span><span class="org-comment">(message "custom ID insertions: %s" headline-UIDs)</span>
    (<span class="org-keyword">cl-loop</span> for pos-insertion in (reverse headline-UIDs) do
        (<span class="org-keyword">let</span> ((pos (car pos-insertion))
              (insertion (cdr pos-insertion)))
            (goto-char pos)
            (insert insertion)))))

<span class="codex-child-link-from-parent"><a href="#__NREF__get-unique-id">get-unique-id</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">UID-for-all-headlines</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__UID-for-all-headlines">&#x1f517;</a></span></div></div><p>
<code>codex-get-unique-id</code> converts a given headline to its canonical form (every non-word character converted to a dash) and performs a lookup against the hash table. If the entry exists, it looks up a <code>entry-N</code> value in a loop with <code>N</code> increasing until it sees that no such key exists.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__get-unique-id">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-unique-id</span> (headline hash-table)
  (<span class="org-keyword">let*</span> ((name (org-element-property <span class="org-builtin">:raw-value</span> headline))
         (disambiguation-number 0)
         (key (concat <span class="org-string">"h-"</span> (codex-normalize-string name)))
         (val (gethash key hash-table)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Discard the key if a value already exists. This drives up the</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">disambiguation number.</span>
    (<span class="org-keyword">while</span> val
      (<span class="org-keyword">setq</span> disambiguation-number (+ 1 disambiguation-number))
      (<span class="org-keyword">setq</span> key (concat <span class="org-string">"h-"</span>
                        (codex-normalize-string
                         (format <span class="org-string">"%s-%s"</span> name disambiguation-number))))
      (<span class="org-keyword">setq</span> val (gethash key hash-table)))
    (puthash key t hash-table)
    key))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-normalize-string</span> (s)
  (string-trim
    (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z0-9]"</span> <span class="org-string">"-"</span> s)
    <span class="org-string">"-"</span>
    <span class="org-string">"-"</span>))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__UID-for-all-headlines">get-unique-id</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__get-unique-id">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Give-polyblocks-a----name-------field--HTML-ID" class="outline-6">
<h6 id="h-Give-polyblocks-a----name-------field--HTML-ID"><span class="section-number-6">3.2.1.2.3.</span> Give polyblocks a <code>#+name: ...</code> field (HTML ID)</h6>
<div class="outline-text-6" id="text-h-Give-polyblocks-a----name-------field--HTML-ID">
<p>
Only source code blocks that have a <code>#+name: ...</code> field (org name field) get an HTML ID (org ID) assigned to it. The problem with polyblocks is that they are not assigned an org name field by default.
</p>

<p>
Of course, we still want all polyblock to have an HTML ID, which can then be extracted by <a href="#coderef-codex-get-src-block-HTML_ID" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-codex-get-src-block-HTML_ID');" onmouseout="CodeHighlightOff(this, 'coderef-codex-get-src-block-HTML_ID');"><code>codex-get-src-block-HTML_ID</code></a> to build up the <code>child-HTML_ID-hash-table</code> in <a href="#h-Link-noweb-references--link-to-child-block-from-parent-block">3.2.1.3.3</a>. If we don't do this then parent source code blocks won't be able to link to the polyblock at all.
</p>

<p>
(Monoblocks with a <code>#+name: ...</code> field get a unique HTML ID assigned to it in the form <code>orgN</code> where <code>N</code> is a hexadecimal number. By default Org generates a random number for <code>N</code>, but we use a simple counter that increments, starting from 0 (see <a href="#h-Do-not-use-random-numbers-for-the-HTML--id--attribute">3.2.1.5.3</a>).)
</p>

<p>
What we can do is inject a <code>#+name: ___polyblock-N</code> line (where <code>N</code> is an incrementing number) into the beginning of the source code section of all polyblocks. Then we can construct an HTML link to any polyblock.
</p>

<p>
Note that we only name the first polyblock in the set of polyblocks that share the same noweb-ref. This is so that we link to the first polyblock child from the parent block (because the assumption is that we will want to start reading about this set of polyblocks beginning with the first block).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__UID-for-all-polyblocks">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-UID-for-all-polyblocks</span> (_)
  (<span class="org-keyword">let*</span> ((all-src-blocks
           <span class="codex-child-link-from-parent"><a href="#__NREF__all-src-blocks">all-src-blocks</a></span>)
         (polyblock-id 0)
         (noweb-ref-last <span class="org-string">""</span>)
         (polyblock-UIDs
           (-remove 'null
             (<span class="org-keyword">cl-loop</span> for src-block in all-src-blocks collect
               (<span class="org-keyword">let*</span> ((noweb-ref (codex-get-noweb-ref-name src-block))
                      (is-polyblock
                       (<span class="org-keyword">and</span>
                         noweb-ref
                         (not (org-element-property <span class="org-builtin">:name</span> src-block))))
                      (pos (org-element-property <span class="org-builtin">:begin</span> src-block))
                      (name-field-with-uid (format <span class="org-string">"#+name: ___polyblock-%s\n"</span> polyblock-id)))
                 (<span class="org-keyword">when</span> (<span class="org-keyword">and</span>
                         is-polyblock
                         (not (string= noweb-ref noweb-ref-last)))
                   (<span class="org-keyword">setq</span> noweb-ref-last noweb-ref)
                   (<span class="org-keyword">setq</span> polyblock-id (+ 1 polyblock-id))
                   (cons pos name-field-with-uid)))))))
    (<span class="org-keyword">cl-loop</span> for polyblock-UID in (reverse polyblock-UIDs) do
        (<span class="org-keyword">let</span> ((pos (car polyblock-UID))
              (name-field-with-uid (cdr polyblock-UID)))
            (goto-char pos)
            (insert name-field-with-uid)))))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">UID-for-all-polyblocks</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__UID-for-all-polyblocks">&#x1f517;</a></span></div></div>
</div>
</div>
</div>

<div id="outline-container-h-HTML-modifications" class="outline-5">
<h5 id="h-HTML-modifications"><span class="section-number-5">3.2.1.3.</span> HTML modifications</h5>
<div class="outline-text-5" id="text-h-HTML-modifications">
</div>

<div id="outline-container-h-Use-human-readable-HTML-IDs-for-source-code-links" class="outline-6">
<h6 id="h-Use-human-readable-HTML-IDs-for-source-code-links"><span class="section-number-6">3.2.1.3.1.</span> Use human-readable HTML IDs for source code links</h6>
<div class="outline-text-6" id="text-h-Use-human-readable-HTML-IDs-for-source-code-links">
<p>
Recall that there are 2 types of source code blocks: <a href="#org0000000">monoblocks</a> and <a href="#org0000002">polyblocks</a>.
</p>

<p>
Polyblocks do get a name field attached to them during the <a href="#h-Give-polyblocks-a----name-------field--HTML-ID">Org modification stage</a>, in the format <code>___polyblock-N</code>. These names are for HTML link generation only, because the user won't see them &#x2014; they will instead just see <code>org000012</code> or some such. In fact, all monoblocks are also given these random-looking (and unstable) <code>org...</code> HTML IDs.
</p>

<p>
And therein lies the problem: if a user decides to bookmark a particular source code block, whether a monoblock or polyblock, they will link to an <code>org...</code>-style ID and chances are that this link will break over time.
</p>

<p>
This is exactly the same problem we have for headlines. For headlines we solved the problem with a <a href="#h-Human-readable-UIDs--Headings--aka-headlines">hash table</a>, and we need to do the same thing here. The major difference, though, is that unlike headlines which can accept a <code>CUSTOM_ID</code> Org property, source code blocks have no such facility. So instead of modifying the buffer (as we do for headlines), we have to modify the final HTML output instead.
</p>

<p>
The solution is to simply look at all source code block links, then modify the <code>id=...</code> part so that it looks like a more human-readable ID. We can extract the human-readable ID by looking at the smart captions inside the <code>&lt;label&gt;...&lt;/label&gt;</code> area for both monoblocks and polyblocks. And then it's just a matter of doing a basic search-and-replace across the entire buffer (HTML file).
</p>

<p>
We have to do a search-and-replace across the entire file because we may also have manual links to source code blocks (although &#x2014; maybe it's just not worth it because we can't refer to polyblocks anyway by name).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-human-readable-src-block-ids"><span class="org-comment-delimiter">; </span><span class="org-comment">Define a global hash table for mapping Org-mode-generated ids (that look like "org00012") for source code blocks to a more human-readable ID.</span>
(<span class="org-keyword">setq</span> codex-org_id-human_id-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-populate-org_id-human_id-hash-table</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> ((block-name (codex-get-src-block-name-from-html src-block-html))
           (orgid (codex-get-src-block-HTML_ID src-block-html)))
      (<span class="org-keyword">when</span> orgid
        (puthash orgid block-name codex-org_id-human_id-hash-table))
      src-block-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-replace-ord_ids-with-human_ids</span> (entire-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let</span> ((html-oneline (codex-to-single-line entire-html)))
      (maphash
       (<span class="org-keyword">lambda</span> (k v)
        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> k v)
         (<span class="org-keyword">setq</span> html-oneline
               (replace-regexp-in-string
                (rx-to-string `(<span class="org-keyword">and</span> <span class="org-string">" id="</span> (* (not <span class="org-string">"\""</span>)) <span class="org-string">"\""</span> ,k <span class="org-string">"\""</span>))
                (format <span class="org-string">" id=\"%s\""</span> v) html-oneline))
         (<span class="org-keyword">setq</span> html-oneline
               (replace-regexp-in-string
                (rx-to-string `(<span class="org-keyword">and</span> <span class="org-string">" href="</span> (* (not <span class="org-string">"\""</span>)) <span class="org-string">"\"#"</span> ,k <span class="org-string">"\""</span>))
                (format <span class="org-string">" href=\"#%s\""</span> v) html-oneline))))
       codex-org_id-human_id-hash-table)
      (codex-to-multi-line html-oneline))))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-human-readable-src-block-ids</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-human-readable-src-block-ids">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Pretty-source-code-captions" class="outline-6">
<h6 id="h-Pretty-source-code-captions"><span class="section-number-6">3.2.1.3.2.</span> Pretty source code captions</h6>
<div class="outline-text-6" id="text-h-Pretty-source-code-captions">
<p>
Here there are basically 3 things we have to keep track of:
</p>

<ol class="org-ol">
<li>the outer <code>&lt;div&gt;</code> that encloses the entire source code block,</li>
<li>the <code>&lt;label&gt;</code>, if any (it may not exist), and</li>
<li>the <code>&lt;pre&gt;</code> content.</li>
</ol>

<p>
We only care about source code blocks with a <code>&lt;label&gt;</code> because that determines whether we have a "Listing: &#x2026;" or not. We just need to save the 3 bits of information, and then:
</p>

<ol class="org-ol">
<li>print the outer <code>&lt;div ...&gt;</code>,</li>
<li>print the <code>&lt;pre&gt;</code> content, and</li>
<li>print the <code>&lt;label&gt;</code> content but as a <code>&lt;div&gt;</code>.</li>
</ol>

<p>
For the last step, we want to additionally parse the inner "Listing N &#x2026; PARENT-link" text and transform it with reordering and also additional metadata information such as <code>&lt;span class="..."&gt;</code> tags.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-prettify-source-code-captions">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-prettify-source-code-captions</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Break up source block into 3 subparts --- the leading &lt;div ...&gt;, the &lt;label ...&gt;&lt;/label&gt; (if any) and</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">&lt;pre ...&gt;&lt;/pre&gt;.</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Then run the linkifying logic against only the body, and then return the</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">original label and new body.</span>
    (<span class="org-keyword">let*</span> ((div-caption-body (codex-get-source-block-html-parts-without-newlines src-block-html))
           (leading-div (nth 0 div-caption-body))
           (body (nth 2 div-caption-body))
           (pre-id-match
             (string-match
               (rx-to-string
                 '(and
                       <span class="org-string">"&lt;pre "</span>
                       (* (not <span class="org-string">"&gt;"</span>))
                       <span class="org-string">"id=\""</span>
                       (group (+ (not <span class="org-string">"\""</span>)))))
               body))
           (pre-id
             (<span class="org-keyword">if</span> pre-id-match
                 (match-string-no-properties 1 body)
                 <span class="org-string">"#deadlink"</span>))
           (body-with-newlines
            (codex-to-multi-line body))
           (caption (nth 1 div-caption-body))
           (caption-parts
             (<span class="org-keyword">let*</span> ((caption-match
                      (string-match <span class="org-string">"&lt;label [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/label&gt;"</span> caption)))
               (<span class="org-keyword">if</span> caption-match
                   (match-string-no-properties 1 caption)
                   <span class="org-string">""</span>)))
           (source-block-name-match
             (string-match
               (rx-to-string
                 '(and
                       <span class="org-string">"&lt;code&gt;"</span>
                       (group (+ (not <span class="org-string">"&lt;"</span>)))
                       <span class="org-string">"&lt;/code&gt;"</span>))
               caption-parts))
           (source-block-name
             (<span class="org-keyword">if</span> source-block-name-match
                 (match-string-no-properties 1 caption-parts)
                 <span class="org-string">""</span>))
           (source-block-name-styled
             (<span class="org-keyword">cond</span> ((string-prefix-p <span class="org-string">"__NREF__"</span> source-block-name)
                    (concat
                      <span class="org-string">"&lt;span class=\"codex-caption-source-code-block-name\"&gt;"</span>
                      (string-remove-prefix <span class="org-string">"__NREF__"</span> source-block-name)
                      <span class="org-string">"&lt;/span&gt;"</span>))
                   (t
                    (concat
                      <span class="org-string">"&lt;span class=\"codex-caption-source-code-block-name\"&gt;"</span>
                      <span class="org-string">"&amp;#x1f4c4; "</span>
                      source-block-name
                      <span class="org-string">"&lt;/span&gt;"</span>))))
           (parent-id-match
             (string-match
               (rx-to-string
                 '(and
                       <span class="org-string">" &lt;a href=\""</span>
                       (group (+ (not <span class="org-string">"\""</span>)))))
               caption-parts))
           (parent-id
             (<span class="org-keyword">if</span> parent-id-match
                 (format <span class="org-string">"&lt;span class=\"codex-caption-parent-link\"&gt;&lt;a href=\"%s\"&gt;%s&lt;/a&gt;&lt;/span&gt;"</span>
                   (match-string-no-properties 1 caption-parts) (string-remove-prefix <span class="org-string">"__NREF__"</span> source-block-name))
                 <span class="org-string">""</span>))
           (link-symbol
             (<span class="org-keyword">if</span> parent-id-match
                 (format <span class="org-string">"&lt;span class=\"codex-caption-link-symbol\"&gt;&lt;a href=\"#%s\"&gt;&amp;#x1f517;&lt;/a&gt;&lt;/span&gt;"</span>
                   pre-id)
                 <span class="org-string">""</span>))
           (listing-number-match
             (string-match
               (rx-to-string
                 '(and <span class="org-string">"Listing "</span>
                       (group (+ (any digit)))))
               caption-parts))
           (listing-number
             (<span class="org-keyword">if</span> listing-number-match
                 (format <span class="org-string">"&lt;span class=\"codex-caption-listing-number\"&gt;&lt;a href=\"#%s\"&gt;#%s&lt;/a&gt;&lt;/span&gt;"</span>
                   pre-id
                   (match-string-no-properties 1 caption-parts))
                 <span class="org-string">""</span>)))
      (<span class="org-keyword">if</span> (s-blank? caption)
       src-block-html
       (concat
        leading-div
        <span class="org-string">"&lt;div class=\"codex-pre-with-caption\"&gt;"</span>
        body-with-newlines
        <span class="org-string">"&lt;/div&gt;"</span>
        <span class="org-string">"&lt;div class=\"codex-caption\"&gt;"</span>
        parent-id
        link-symbol
        <span class="org-string">"&lt;/div&gt;"</span>
        <span class="org-string">"&lt;/div&gt;"</span>)))))

<span class="codex-child-link-from-parent"><a href="#__NREF__codex-get-source-block-html-parts-without-newlines">codex-get-source-block-html-parts-without-newlines</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-prettify-source-code-captions</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-prettify-source-code-captions">&#x1f517;</a></span></div></div><p>
This is a helper function to parse the HTML output for a source code block.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-get-source-block-html-parts-without-newlines">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-source-block-html-parts-without-newlines</span> (src-block-html)
    (<span class="org-keyword">let*</span> ((one-line (codex-to-single-line src-block-html))
           (leading-div
             (<span class="org-keyword">let</span> ((div-match
                    (string-match <span class="org-string">"&lt;div [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;"</span> one-line)))
               (match-string-no-properties 0 one-line)))
           (caption
             (<span class="org-keyword">let*</span> ((caption-match
                      (string-match <span class="org-string">"&lt;label [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;.*?&lt;/label&gt;"</span> one-line)))
               (<span class="org-keyword">if</span> caption-match
                   (match-string-no-properties 0 one-line)
                   <span class="org-string">""</span>)))
           (body (<span class="org-keyword">progn</span> (string-match <span class="org-string">"&lt;pre [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+&gt;.*?&lt;/pre&gt;"</span> one-line)
                        (match-string-no-properties 0 one-line))))
      `(,leading-div ,caption ,body)))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex-prettify-source-code-captions">codex-get-source-block-html-parts-without-newlines</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-get-source-block-html-parts-without-newlines">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Link-noweb-references--link-to-child-block-from-parent-block" class="outline-6">
<h6 id="h-Link-noweb-references--link-to-child-block-from-parent-block"><span class="section-number-6">3.2.1.3.3.</span> Link noweb references (link to child block from parent block)</h6>
<div class="outline-text-6" id="text-h-Link-noweb-references--link-to-child-block-from-parent-block">
<p>
Consider the following code:
</p>

<div class="org-src-container"><pre class="src src-org"><span class="org-org-meta-line">#+name: parent-block</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"Hello from the parent block"</span></span>
<span class="org-org-block">__NREF__child-block-1</span>
<span class="org-org-block">__NREF__child-block-2</span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+name: child-block-1</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"I am child 1"</span></span>
<span class="org-org-block-end-line">#+end_src</span>

...

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> -n </span><span class="org-org-block"><span class="org-string">"I am "</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+header: :noweb-ref child-block-2</span>
<span class="org-org-block-begin-line">#+begin_src bash</span>
<span class="org-org-block"><span class="org-builtin">echo</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"child 2"</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre></div><p>
What we want to do is to make the <code>__NREF__child-block-1</code> and <code>__NREF__child-block-2</code> references inside <code>parent-block</code> to link to their definitions, so that the reader can just click on them to go to see how they're defined. Unfortunately Org mode doesn't do this by default so we have to do this ourselves.
</p>

<p>
In the case of <code>child-block-2</code>, it is defined in multiple blocks so we would want to link to the very first block.
</p>

<p>
We cannot use a <code>org-export-before-parsing-hook</code> like we did in <a href="#__NREF__codex-publish-modify-org"><code>__NREF__codex-publish-modify-org</code></a> because at that stage of processing, we are dealing with Org mode syntax. Any modifications we make to the parent source code block will be treated as text upon HTML export. Thankfully Org mode allows customizations on generated HTML through the <code>org-export-filter-src-block-functions</code> variable. This variable is analogous to <code>org-export-before-parsing-hook</code>, but operates at the HTML level (not at the Org syntax level) for source code blocks, which is exactly what we need.
</p>

<p>
So we have to craft valid HTML links (not Org links) to the child source code blocks. For this we need the actual <code>id</code> part of the HTML <code>&lt;pre&gt;...</code> block that will hold the source code. That is, the algorithm should be something like:
</p>

<ol class="org-ol">
<li>for every parent source code block,</li>
<li>for every child block (noweb) referenced in the body, insert an HTML link to the child block (lookup in <code>child-HTML_ID-hash-table</code>).</li>
</ol>

<p>
The only thing remaining is the construction of <code>child-HTML_ID-hash-table</code>. We can construct this by mapping through all source code blocks and getting the name which can be just drawn from the <code>&lt;label ...&gt;</code> HTML tag, thanks to the smart captions we inserted for all child blocks earlier in <a href="#h-Smart-source-code-block-captions"><i>Smart source code block captions</i></a>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex-html-filter-src-blocks"><span class="org-comment-delimiter">; </span><span class="org-comment">Define a global hash table for mapping child source block names to their HTML IDs.</span>
(<span class="org-keyword">setq</span> codex-child-HTML_ID-hash-table (make-hash-table <span class="org-builtin">:test</span> 'equal))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-populate-child-HTML_ID-hash-table</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">let*</span> ((child-name (codex-get-src-block-name-from-html src-block-html))
           (child-HTML_ID (codex-get-src-block-HTML_ID src-block-html)))
      (<span class="org-keyword">if</span> child-HTML_ID <span class="org-comment-delimiter">; </span><span class="org-comment">Skip blocks that lack an HTML ID, such as non-head polyblocks.</span>
        (puthash child-name child-HTML_ID codex-child-HTML_ID-hash-table))
      <span class="org-comment-delimiter">; </span><span class="org-comment">Return src-block-html as-is (no modifications).</span>
      src-block-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-src-block-name-from-html</span> (src-block-html)
  (<span class="org-keyword">let*</span> ((match-nref (string-match
                      (concat
                       <span class="org-string">"&lt;label.+?&lt;code&gt;"</span>
                       (codex-nref-rx nil)
                       <span class="org-string">"&lt;/code&gt;"</span>)
                      src-block-html))
         (match-raw (<span class="org-keyword">if</span> (not match-nref)
                        (string-match
                         (rx-to-string
                          '(and
                            <span class="org-string">"&lt;label"</span>
                            (+ (not <span class="org-string">"&gt;"</span>))
                            <span class="org-string">"&gt;"</span>
                            (group (*? anychar))
                            <span class="org-string">"&lt;/label&gt;"</span>))
                         src-block-html)))
         (matched-contents (match-string-no-properties 1 src-block-html)))
    (<span class="org-keyword">if</span> match-nref
        matched-contents
        (<span class="org-keyword">if</span> match-raw
            (codex-clean-up-match-raw matched-contents)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-clean-up-match-raw</span> (s)
  (<span class="org-keyword">let*</span> ((normalized (codex-normalize-string s))
         (rx (rx-to-string
                '(and
                  <span class="org-string">"Listing-"</span>
                  (+ (any digit))
                  (+ <span class="org-string">"-"</span>)
                  <span class="org-string">"span"</span>
                  (* <span class="org-string">"-"</span>)
                  (group (+ anychar)))))
         (match (string-match rx normalized)))
    (<span class="org-keyword">if</span> match
        (match-string-no-properties 1 normalized)
        normalized)))

<span id="coderef-codex-get-src-block-HTML_ID" class="coderef-off">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-get-src-block-HTML_ID</span> (src-block-html)</span>
  (<span class="org-keyword">let</span> ((match (string-match <span class="org-string">"&lt;pre [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;]+?id=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"&gt;"</span> src-block-html)))
    (<span class="org-keyword">if</span> match (match-string-no-properties 1 src-block-html))))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-link-to-children-from-parent-body</span> (src-block-html backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Break up source block into 3 subparts --- the leading &lt;div ...&gt;, the &lt;label ...&gt;&lt;/label&gt; (if any) and</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">&lt;pre ...&gt;&lt;/pre&gt;.</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Then run the linkifying logic against only the body, and then return the</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">original label and new body.</span>
    (<span class="org-keyword">let*</span> ((div-caption-body (codex-get-source-block-html-parts-without-newlines src-block-html))
           (leading-div (nth 0 div-caption-body))
           (caption (nth 1 div-caption-body))
           (body (nth 2 div-caption-body))
           (body-linkified-without-newlines
            (replace-regexp-in-string
             (codex-nref-rx nil)
             (<span class="org-keyword">lambda</span> (child-name-text)
                 (<span class="org-keyword">let*</span> ((HTML_ID (gethash child-name-text codex-child-HTML_ID-hash-table)))
                  (<span class="org-keyword">if</span> HTML_ID
                      (concat <span class="org-string">"&lt;span class=\"codex-child-link-from-parent\"&gt;&lt;a href=\"#"</span> HTML_ID <span class="org-string">"\"&gt;"</span>
                              (string-remove-prefix <span class="org-string">"__NREF__"</span> child-name-text)
                              <span class="org-string">"&lt;/a&gt;&lt;/span&gt;"</span>)
                      child-name-text)))
             body))
           (body-linkified-with-newlines
            (codex-to-multi-line body-linkified-without-newlines)))
      (concat leading-div caption body-linkified-with-newlines <span class="org-string">"&lt;/div&gt;"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-to-single-line</span> (s)
  (replace-regexp-in-string <span class="org-string">"\n"</span> <span class="org-string">"&lt;&lt;&lt;NEWLINE&gt;&gt;&gt;"</span> s))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-to-multi-line</span> (s)
  (replace-regexp-in-string <span class="org-string">"&lt;&lt;&lt;NEWLINE&gt;&gt;&gt;"</span> <span class="org-string">"\n"</span> s))

<span class="codex-child-link-from-parent"><a href="#__NREF__custom-noweb-delimiters">custom-noweb-delimiters</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__babel-load-languages">babel-load-languages</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__evaluate-all-blocks">evaluate-all-blocks</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-codex-publish">codex-html-filter-src-blocks</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex-html-filter-src-blocks">&#x1f517;</a></span></div></div><p>
Note that we need to evaluate this lisp code if we want to run <code>C-c C-v t</code> to tangle code blocks properly in an interactive manner from an Emacs editing session.
</p>

<p>
FIXME: Evaluate this snippet of code when loading this file for editing purposes?
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__custom-noweb-delimiters">(<span class="org-keyword">setq</span> org-babel-noweb-wrap-start <span class="org-string">"__NREF__"</span>)
(<span class="org-keyword">setq</span> org-babel-noweb-wrap-end <span class="org-string">""</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-nref-rx</span> (match-optional-params)
  (rx-to-string
   (codex-nref-rx-primitive match-optional-params)))

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-nref-rx-primitive</span> (match-optional-params)
  (<span class="org-keyword">if</span> match-optional-params
   `(group
           <span class="org-string">"__NREF__"</span>
          (any alpha) <span class="org-comment-delimiter">;; </span><span class="org-comment">Noweb reference must start with a letter...</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">...and must be followed by letters,numbers,dashes,underscores,periods...</span>
          (* (<span class="org-keyword">or</span> (any alnum) <span class="org-string">"-"</span> <span class="org-string">"_"</span> <span class="org-string">"."</span>))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">...and may terminate with a "(...)" where the "..." may be an empty string, or some other argument.</span>
          (* (<span class="org-keyword">or</span> <span class="org-string">"()"</span>
                 (<span class="org-keyword">and</span> <span class="org-string">"("</span>
                      (* (not <span class="org-string">")"</span>))
                      <span class="org-string">")"</span>))))
   `(group
          <span class="org-string">"__NREF__"</span>
          (any alpha)
          (* (<span class="org-keyword">or</span> (any alnum) <span class="org-string">"-"</span> <span class="org-string">"_"</span> <span class="org-string">"."</span>)))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">We only use starting delimiters. All of them start with comment characters recognized by various languages, exept for "__NREF__". This last one is a catch-all in case we want to inject a noweb reference on a line with some trailing content (because we cannot do ";; NREF: foo)" --- notice the trailing parentheses --- in elisp, because parinfer destroys it during an editing session).</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">See https://emacs.stackexchange.com/a/73720/13006. Customize noweb delimiters.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-noweb-wrap</span> (<span class="org-type">&amp;optional</span> regexp)
  <span class="org-doc">"Return regexp matching a Noweb reference.</span>

<span class="org-doc">Match any reference, or only those matching REGEXP, if non-nil.</span>
<span class="org-doc">When matching, reference is stored in match group 1."</span>
  (codex-nref-rx t))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex-html-filter-src-blocks">custom-noweb-delimiters</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__custom-noweb-delimiters">&#x1f517;</a></span></div></div><p>
We need to do this; otherwise we cannot evaluate any source code blocks during weaving (while running emacs from the command line in batch mode).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__babel-load-languages"><span class="org-comment-delimiter">;</span><span class="org-comment">(org-babel-do-load-languages</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">'org-babel-load-languages '((shell . t)))</span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex-html-filter-src-blocks">babel-load-languages</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__babel-load-languages">&#x1f517;</a></span></div></div><div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__evaluate-all-blocks">(<span class="org-keyword">setq</span> org-confirm-babel-evaluate nil)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex-html-filter-src-blocks">evaluate-all-blocks</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__evaluate-all-blocks">&#x1f517;</a></span></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks" class="outline-5">
<h5 id="h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks"><span class="section-number-5">3.2.1.4.</span> Autogenerate CSS for syntax highlighting of source code blocks</h5>
<div class="outline-text-5" id="text-h-Autogenerate-CSS-for-syntax-highlighting-of-source-code-blocks">
<p>
See <a href="https://emacs.stackexchange.com/questions/31439/how-to-get-colored-syntax-highlighting-of-code-blocks-in-asynchronous-org-mode-e">https://emacs.stackexchange.com/questions/31439/how-to-get-colored-syntax-highlighting-of-code-blocks-in-asynchronous-org-mode-e</a>, specifically <a href="https://emacs.stackexchange.com/a/36759">https://emacs.stackexchange.com/a/36759</a>.
</p>

<p>
Generate <code>syntax-highlighting.css</code> and quit emacs. This function is designed to be run from the command line on a fresh emacs instance (dedicated OS process). Unfortunately, by itself it is almost useless (see <a href="#__NREF__enable-syntax-highlighting-from-batch-mode"><code>__NREF__enable-syntax-highlighting-from-batch-mode</code></a>).
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-autogenerate-css">(<span class="org-keyword">defun</span> <span class="org-function-name">batch-org-gen-css-and-exit</span> (org-file)
  (find-file org-file)
  (font-lock-flush)
  (font-lock-fontify-buffer)
  (org-html-htmlize-generate-css)
  (<span class="org-keyword">with-current-buffer</span> <span class="org-string">"*html*"</span>
    (write-file <span class="org-string">"syntax-highlighting.css"</span>))
  (kill-emacs))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Without this, batch-org-gen-css-and-exit produces a near-empty CSS file.</span>
<span class="codex-child-link-from-parent"><a href="#__NREF__enable-syntax-highlighting-from-batch-mode">enable-syntax-highlighting-from-batch-mode</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-autogenerate-css</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-autogenerate-css">&#x1f517;</a></span></div></div><p>
Sadly, <code>batch-org-gen-css-and-exit</code> by itself generates a near-blank CSS file. So we have to use code from <a href="https://emacs.stackexchange.com/questions/38437/org-mode-batch-export-missing-syntax-highlighting">https://emacs.stackexchange.com/questions/38437/org-mode-batch-export-missing-syntax-highlighting</a>:
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__enable-syntax-highlighting-from-batch-mode">(<span class="org-keyword">require</span> '<span class="org-constant">font-lock</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">subr-x</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">for `</span><span class="org-comment"><span class="org-constant">when-let</span></span><span class="org-comment">'</span>

(<span class="org-keyword">unless</span> (boundp 'maximal-integer)
  (<span class="org-keyword">defconst</span> <span class="org-variable-name">maximal-integer</span> (lsh -1 -1)
    <span class="org-doc">"Maximal integer value representable natively in emacs lisp."</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-default</span> (spec)
  <span class="org-doc">"Get list containing at most the default entry of face SPEC.</span>
<span class="org-doc">Return nil if SPEC has no default entry."</span>
  (<span class="org-keyword">let*</span> ((first (car-safe spec))
     (display (car-safe first)))
    (<span class="org-keyword">when</span> (eq display 'default)
      (list (car-safe spec)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-min-color</span> (display-atts)
  <span class="org-doc">"Get min-color entry of DISPLAY-ATTS pair from face spec."</span>
  (<span class="org-keyword">let*</span> ((display (car-safe display-atts)))
    (<span class="org-keyword">or</span> (car-safe (cdr (assoc 'min-colors display)))
    maximal-integer)))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-highest-color</span> (spec)
  <span class="org-doc">"Search face SPEC for highest color.</span>
<span class="org-doc">That means the DISPLAY entry of SPEC</span>
<span class="org-doc">with class 'color and highest min-color value."</span>
  (<span class="org-keyword">let</span> ((color-list (cl-remove-if-not
             (<span class="org-keyword">lambda</span> (display-atts)
               (<span class="org-keyword">when-let</span> ((display (car-safe display-atts))
                  (class (<span class="org-keyword">and</span> (listp display)
                          (assoc 'class display)))
                  (background (assoc 'background display)))
             (<span class="org-keyword">and</span> (member 'light (cdr background))
                  (member 'color (cdr class)))))
             spec)))
    (cl-reduce (<span class="org-keyword">lambda</span> (display-atts1 display-atts2)
         (<span class="org-keyword">if</span> (&gt; (face-spec-min-color display-atts1)
            (face-spec-min-color display-atts2))
             display-atts1
           display-atts2))
           (cdr color-list)
           <span class="org-builtin">:initial-value</span> (car color-list))))

(<span class="org-keyword">defun</span> <span class="org-function-name">face-spec-t</span> (spec)
  <span class="org-doc">"Search face SPEC for fall back."</span>
  (cl-find-if (<span class="org-keyword">lambda</span> (display-atts)
        (eq (car-safe display-atts) t))
          spec))

<span class="org-comment-delimiter">; </span><span class="org-comment">This is slightly tweaked from the original, because the incoming "face" value can look like (fixed-pitch face-name) --- so we take the second element.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-face-attribute</span> (face attribute <span class="org-type">&amp;optional</span> frame inherit)
  <span class="org-doc">"Get FACE ATTRIBUTE from `</span><span class="org-doc"><span class="org-constant">face-user-default-spec</span></span><span class="org-doc">' and not from `</span><span class="org-doc"><span class="org-constant">face-attribute</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let*</span> ((face-spec (face-user-default-spec (<span class="org-keyword">if</span> (listp face) (car (cdr face)) face)))
     (display-attr (<span class="org-keyword">or</span> (face-spec-highest-color face-spec)
               (face-spec-t face-spec)))
     (attr (cdr display-attr))
     (val (<span class="org-keyword">or</span> (plist-get attr attribute) (car-safe (cdr (assoc attribute attr))))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">(message "attribute: %S" attribute) ;; for debugging</span>
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (null (eq attribute <span class="org-builtin">:inherit</span>))
           (null val))
      (<span class="org-keyword">let</span> ((inherited-face (my-face-attribute face <span class="org-builtin">:inherit</span>)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> inherited-face
           (null (eq inherited-face 'unspecified)))
      (<span class="org-keyword">setq</span> val (my-face-attribute inherited-face attribute)))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">(message "face: %S attribute: %S display-attr: %S, val: %S" face attribute display-attr val) ;; for debugging</span>
    (<span class="org-keyword">or</span> val 'unspecified)))

(advice-add 'face-attribute <span class="org-builtin">:override</span> #'my-face-attribute)

<span class="org-comment-delimiter">;; </span><span class="org-comment">Debugging</span>
(<span class="org-keyword">defmacro</span> <span class="org-function-name">print-args-and-ret</span> (fun)
  <span class="org-doc">"Prepare FUN for printing args and return value."</span>
  `(advice-add (<span class="org-keyword">quote</span> ,fun) <span class="org-builtin">:around</span>
           (<span class="org-keyword">lambda</span> (oldfun <span class="org-type">&amp;rest</span> args)
         (<span class="org-keyword">let</span> ((ret (apply oldfun args)))
           (message ,(concat <span class="org-string">"Calling "</span> (symbol-name fun) <span class="org-string">" with args %S returns %S."</span>) args ret)
           ret))
           '((name <span class="org-string">"print-args-and-ret"</span>))))

<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret htmlize-faces-in-buffer)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret htmlize-get-override-fstruct)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret htmlize-face-to-fstruct)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret htmlize-attrlist-to-fstruct)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret face-foreground)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret face-background)</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">(print-args-and-ret face-attribute)</span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-autogenerate-css">enable-syntax-highlighting-from-batch-mode</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__enable-syntax-highlighting-from-batch-mode">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Fix-non-determinism" class="outline-5">
<h5 id="h-Fix-non-determinism"><span class="section-number-5">3.2.1.5.</span> Fix non-determinism</h5>
<div class="outline-text-5" id="text-h-Fix-non-determinism">
<p>
There are some things that Org mode does that annoyingly break determinism. Here we take care to set things right so that we can have reprducible, stable HTML output.
</p>
</div>

<div id="outline-container-h-Do-not-insert-current-time-as-HTML-comment" class="outline-6">
<h6 id="h-Do-not-insert-current-time-as-HTML-comment"><span class="section-number-6">3.2.1.5.1.</span> Do not insert current time as HTML comment</h6>
<div class="outline-text-6" id="text-h-Do-not-insert-current-time-as-HTML-comment">
<p>
Org mode also injects an HTML comment (not visible to the user) to record the time that the HTML was generated. We disable this because it breaks deterministic output. See <a href="https://emacs.stackexchange.com/questions/50117/how-to-disable-commented-date-in-org-mode-html-export">this link</a> for more info.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-fix-nondeterminism">(<span class="org-keyword">setq</span> org-export-time-stamp-file nil)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-fix-nondeterminism</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-fix-nondeterminism">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Do-not-insert-current-Org-mode-version" class="outline-6">
<h6 id="h-Do-not-insert-current-Org-mode-version"><span class="section-number-6">3.2.1.5.2.</span> Do not insert current Org mode version</h6>
<div class="outline-text-6" id="text-h-Do-not-insert-current-Org-mode-version">
<p>
By default Org mode appends visible metadata at the bottom of the HTML document, including the Org version used to generate the document. We suppress this information.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-postamble nil)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-fix-nondeterminism</a></span><span class="codex-caption-link-symbol"><a href="##deadlink">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Do-not-use-random-numbers-for-the-HTML--id--attribute" class="outline-6">
<h6 id="h-Do-not-use-random-numbers-for-the-HTML--id--attribute"><span class="section-number-6">3.2.1.5.3.</span> Do not use random numbers for the HTML "id" attribute</h6>
<div class="outline-text-6" id="text-h-Do-not-use-random-numbers-for-the-HTML--id--attribute">
<p>
Stop randomized ids from being generated every time. Instead count from 0 and work our way up.
</p>

<p>
See <a href="https://www.reddit.com/r/orgmode/comments/aagmfh/comment/hk6upbf">https://www.reddit.com/r/orgmode/comments/aagmfh/comment/hk6upbf</a>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-export-deterministic-reference</span> (references)
  (<span class="org-keyword">let</span> ((new (length references)))
     (<span class="org-keyword">while</span> (rassq new references) (<span class="org-keyword">setq</span> new (+ new 1)))
     new))
(advice-add #'org-export-new-reference <span class="org-builtin">:override</span> #'org-export-deterministic-reference)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-fix-nondeterminism</a></span><span class="codex-caption-link-symbol"><a href="##deadlink">&#x1f517;</a></span></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Misc-settings" class="outline-5">
<h5 id="h-Misc-settings"><span class="section-number-5">3.2.1.6.</span> Misc settings</h5>
<div class="outline-text-5" id="text-h-Misc-settings">
<p>
Disable backup files for <code>codex.el</code> (that look like <code>codex.el~</code>) when we invoke Emacs from the <a href="#code-Makefile--code">1</a>.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-misc">(<span class="org-keyword">setq</span> make-backup-files nil)
(<span class="org-keyword">setq</span> org-src-preserve-indentation t)

<span class="org-comment-delimiter">; </span><span class="org-comment">See https://stackoverflow.com/a/27285582/437583.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">codex-test-file-name</span> ()
  (concat <span class="org-string">"test_"</span> (file-name-nondirectory (directory-file-name (file-name-directory (buffer-file-name))))  <span class="org-string">".py"</span>))

<span class="codex-child-link-from-parent"><a href="#__NREF__set_html5">set_html5</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-misc</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-misc">&#x1f517;</a></span></div></div>
</div>

<div id="outline-container-h-Use-HTML5-export--not-XML--to-un-break-MathJax" class="outline-6">
<h6 id="h-Use-HTML5-export--not-XML--to-un-break-MathJax"><span class="section-number-6">3.2.1.6.1.</span> Use HTML5 export, not XML (to un-break MathJax)</h6>
<div class="outline-text-6" id="text-h-Use-HTML5-export--not-XML--to-un-break-MathJax">
<p>
By default on Org 9.6, MathJax settings (JavaScript snippet) gets wrapped in a CDATA tag, and we run into the same problem described on this email that has gone unanswered: <a href="https://www.mail-archive.com/emacs-orgmode@gnu.org/msg140821.html">https://www.mail-archive.com/emacs-orgmode@gnu.org/msg140821.html</a>. It appears that this is because the document is exported as XML, not HTMl. Setting the document type to <code>html5</code>, as below, appears to make the CDATA tag magically disappear.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__set_html5">(<span class="org-keyword">setq</span> org-html-doctype <span class="org-string">"html5"</span>)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-misc">set_html5</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__set_html5">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-move-this-bit-into-a-snippet-that-s-autoloaded-upon-opening-up-this-org-file--and-any-other-org-file-that-we-use" class="outline-6">
<h6 id="h-move-this-bit-into-a-snippet-that-s-autoloaded-upon-opening-up-this-org-file--and-any-other-org-file-that-we-use"><span class="section-number-6">3.2.1.6.2.</span> <span class="todo TODO">TODO</span> move this bit into a snippet that's autoloaded upon opening up this org file (and any other org file that we use)</h6>
<div class="outline-text-6" id="text-h-move-this-bit-into-a-snippet-that-s-autoloaded-upon-opening-up-this-org-file--and-any-other-org-file-that-we-use">
<div class="org-src-container"><pre class="src src-emacs-lisp" id="org0000044">(<span class="org-keyword">setq</span> org-id-link-to-org-use-id 't)
</pre></div><p>
The following bit is needed so that Org is able to resolve ID-style links of the form <code>[[id:...][...]</code>. We just list all of our Org files so that they can be parsed for link IDs. We could generate the list of Org files dynamically, but because there are so few of these, we just do it manually here.
</p>

<p>
NOTE: Actually, this doesn't work because we need to inject "ID" properties everywhere (and unfortunately these gets exported, creating a mess) and also the links themselves are broken because of the way we include these files into the main file.
</p>

<div class="org-src-container"><pre class="src src-emacs-lisp" id="org0000046">(<span class="org-keyword">let</span> ((files '(<span class="org-string">"build-literate.org"</span>
               <span class="org-string">"README.org"</span>)))
  (org-id-update-id-locations files))
</pre></div>
</div>
</div>
</div>

<div id="outline-container-h-Imports" class="outline-5">
<h5 id="h-Imports"><span class="section-number-5">3.2.1.7.</span> Imports</h5>
<div class="outline-text-5" id="text-h-Imports">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-imports"><span class="org-comment-delimiter">;; </span><span class="org-comment">Built-in packages (distributed with Emacs).</span>
(<span class="org-keyword">require</span> '<span class="org-constant">tex-mode</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">elisp-mode</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">Third-party packages (checked in as Git submodules)</span>
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/s.el"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/compat.el"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">compat</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/dash.el"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">dash</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/dr-qubit.org"</span>))
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/f.el"</span>))
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/parsebib"</span>))
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/citeproc-el"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">citeproc</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">oc-csl</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/emacs-htmlize"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">htmlize</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/magit/lisp"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">magit-section</span>)
(add-to-list 'load-path (concat (getenv <span class="org-string">"PWD"</span>) <span class="org-string">"/deps/elisp/nix-mode"</span>))
(<span class="org-keyword">require</span> '<span class="org-constant">nix-mode</span>)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-imports</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-imports">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Performance-optimizations" class="outline-5">
<h5 id="h-Performance-optimizations"><span class="section-number-5">3.2.1.8.</span> Performance optimizations</h5>
<div class="outline-text-5" id="text-h-Performance-optimizations">
<p>
This "optimization" is inspired by <a href="https://www.reddit.com/r/emacs/comments/mmdeei/comment/gtvryvy">https://www.reddit.com/r/emacs/comments/mmdeei/comment/gtvryvy</a>. There, the idea was to ignore hooks associated with major modes for the source code blocks, Because they use <code>org-publish</code> and we don't, we can't use the same code but we can still use the same idea. In particular, <code>org-html-export-to-html</code> calls <code>org-html-fontify-code</code> to perform syntax highlighting of source code blocks.
</p>

<p>
During ad-hoc tests, this shaves off a few seconds. This was determined by comparing the regular <code>weave</code> target versus the <code>weave-nocolor</code> target.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-performance-optimization"><span class="org-comment-delimiter">; </span><span class="org-comment">Set garbage-collection threshold to 16 GiB.</span>
(<span class="org-keyword">setq</span> gc-cons-threshold #x400000000)

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-disable-syntax-highlighting</span> (_orig-func <span class="org-type">&amp;rest</span> args)
  (apply 'codex-org-html-fontify-code args))
(<span class="org-keyword">defun</span> <span class="org-function-name">codex-org-html-fontify-code</span> (code lang) (org-html-encode-plain-text code))

<span class="codex-child-link-from-parent"><a href="#__NREF__codex_dot_el-profiling">codex_dot_el-profiling</a></span>
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-codex-el--code">codex_dot_el-performance-optimization</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-performance-optimization">&#x1f517;</a></span></div></div>
</div>

<div id="outline-container-h-Profiling" class="outline-6">
<h6 id="h-Profiling"><span class="section-number-6">3.2.1.8.1.</span> Profiling</h6>
<div class="outline-text-6" id="text-h-Profiling">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-emacs-lisp" id="__NREF__codex_dot_el-profiling">(<span class="org-keyword">defun</span> <span class="org-function-name">codex-publish-profile</span> ()
  (<span class="org-keyword">interactive</span>)
  (profiler-start 'cpu)
  (codex-publish)
  (profiler-stop)
  (profiler-report)
  (profiler-report-write-profile <span class="org-string">"emacs-profile-weave.txt"</span>) t)

(<span class="org-keyword">defun</span> <span class="org-function-name">codex-tangle-profile</span> ()
  (<span class="org-keyword">interactive</span>)
  (profiler-start 'cpu)
  (org-babel-tangle)
  (profiler-stop)
  (profiler-report)
  (profiler-report-write-profile <span class="org-string">"emacs-profile-tangle.txt"</span>) t)
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#__NREF__codex_dot_el-performance-optimization">codex_dot_el-profiling</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__codex_dot_el-profiling">&#x1f517;</a></span></div></div>
</div>
</div>
</div>
</div>

<div id="outline-container-h-Additional--hand-tweaked--CSS" class="outline-4">
<h4 id="h-Additional--hand-tweaked--CSS"><span class="section-number-4">3.2.2.</span> Additional (hand-tweaked) CSS</h4>
<div class="outline-text-4" id="text-h-Additional--hand-tweaked--CSS">
<p>
We add some additional CSS tweaks on top of the default "ReadTheOrg" (FIXME: add link) theme that we use.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-css" id="code-style-css--code"><span class="org-css-selector">a </span>{
    <span class="org-css-property">color</span>: <span class="custom-2">#0000ff</span>;
}

<span class="org-css-selector">body, p, li, h1, h2, h3, h4, h5, h6, legend </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"Source Serif Pro, serif"</span>;
}

<span class="org-css-selector">p, li </span>{
    <span class="org-css-property">line-height</span>: 1.2em;
}

<span class="org-css-selector">p, ol, ul </span>{
    <span class="org-css-property">margin-bottom</span>: 0.5em;
}

<span class="org-css-selector">li </span>{
    <span class="org-css-property">margin-bottom</span>: 0;
}

<span class="org-css-selector">table </span>{
    <span class="org-css-property">margin</span>: 1em auto 0em auto;
}

<span class="org-comment-delimiter">/* </span><span class="org-comment">Center all images.</span><span class="org-comment-delimiter"> */</span>
<span class="org-css-selector">img </span>{
    <span class="org-css-property">display</span>: block;
    <span class="org-css-property">margin</span>: 0 auto;
}

<span class="org-comment-delimiter">/* </span><span class="org-comment">Increase text size for smaller sections.</span><span class="org-comment-delimiter"> */</span>
<span class="org-css-selector">h5 </span>{
    <span class="org-css-property">margin-top</span>: 1em;
    <span class="org-css-property">margin-bottom</span>: 1em;
    <span class="org-css-property">font-size</span>: 12pt;
}
<span class="org-css-selector">h6 </span>{
    <span class="org-css-property">margin-top</span>: 1em;
    <span class="org-css-property">margin-bottom</span>: 1em;
    <span class="org-css-property">font-size</span>: 12pt;
}
<span class="org-css-selector">h7 </span>{
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">font-size</span>: 12pt;
}
<span class="org-css-selector">.outline-7 </span>{
    <span class="org-css-property">margin-top</span>: 1em;
}

<span class="org-css-selector">code </span>{
    <span class="org-css-property">background</span>: <span class="custom-1">#eee</span>;
    <span class="org-css-property">padding-left</span>: 0.5em;
    <span class="org-css-property">padding-right</span>: 0.5em;
    <span class="org-css-property">white-space</span>: nowrap;
}

<span class="org-css-selector">thead </span>{
    <span class="org-css-property">background</span>: <span class="custom-1">#eee</span>;
}

<span class="org-css-selector">pre </span>{
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: <span class="custom">#999</span>;
    <span class="org-css-property">border-radius</span>: 5px;
}

<span class="codex-child-link-from-parent"><a href="#__NREF__css-source-code-block-body">css-source-code-block-body</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__css-source-code-block-captions">css-source-code-block-captions</a></span>

<span class="codex-child-link-from-parent"><a href="#__NREF__css-source-code-block-child-link-from-parent">css-source-code-block-child-link-from-parent</a></span>
</pre></div><div class="codex-caption"></div></div>
</div>

<div id="outline-container-h-Source-code-block-body" class="outline-5">
<h5 id="h-Source-code-block-body"><span class="section-number-5">3.2.2.1.</span> Source code block body</h5>
<div class="outline-text-5" id="text-h-Source-code-block-body">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-css" id="__NREF__css-source-code-block-body"><span class="org-css-selector">.org-src-container </span>{
    <span class="org-css-property">margin-top</span>: 1em;
    <span class="org-css-property">margin-bottom</span>: 1em;
    <span class="org-css-property">border-style</span>: solid;
    <span class="org-css-property">border-width</span>: 1px;
    <span class="org-css-property">border-color</span>: <span class="custom-1">#999</span>;
    <span class="org-css-property">border-radius</span>: 5px;
}

<span class="org-css-selector">.org-src-container pre </span>{
    <span class="org-css-property">margin</span>: 0;
    <span class="org-css-property">font-family</span>: <span class="org-string">"monospace"</span>;
    <span class="org-css-property">border-width</span>: 0;
    <span class="org-css-property">border-radius</span>: 5px;
}

<span class="org-css-selector">.org-src-container .codex-pre-with-caption </span>{
    <span class="org-css-property">border-bottom-left-radius</span>: 0;
    <span class="org-css-property">border-bottom-right-radius</span>: 0;
}

<span class="org-comment-delimiter">/* </span><span class="org-comment">Source code block body.</span><span class="org-comment-delimiter"> */</span>
<span class="org-css-selector">.org-src-container pre.src </span>{
    <span class="org-css-property">background-color</span>: <span class="custom">#eee</span>;
}

</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-style-css--code">css-source-code-block-body</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__css-source-code-block-body">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Source-code-block-captions" class="outline-5">
<h5 id="h-Source-code-block-captions"><span class="section-number-5">3.2.2.2.</span> Source code block captions</h5>
<div class="outline-text-5" id="text-h-Source-code-block-captions">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-css" id="__NREF__css-source-code-block-captions"><span class="org-css-selector">.codex-caption </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">"monospace"</span>;
    <span class="org-css-property">text-align</span>: right;
    <span class="org-css-property">background-color</span>: <span class="custom-4">#ddd</span>;
    <span class="org-css-property">border-bottom-left-radius</span>: 5px;
    <span class="org-css-property">border-bottom-right-radius</span>: 5px;
    <span class="org-css-property">padding-top</span>: 2px;
    <span class="org-css-property">padding-bottom</span>: 2px;
}

<span class="org-css-selector">.codex-caption-source-code-block-name </span>{
    <span class="org-css-property">color</span>: <span class="custom-3">#444444</span>;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">margin-right</span>: 5px;
}

<span class="org-css-selector">.codex-caption-parent-link </span>{
    <span class="org-css-property">margin-top</span>: 5px;
    <span class="org-css-property">margin-right</span>: 5px;
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">font-weight</span>: bold;
}
<span class="org-css-selector">.codex-caption-parent-link a </span>{
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">padding-top</span>: 2px;
    <span class="org-css-property">padding-bottom</span>: 2px;
    <span class="org-css-property">color</span>: <span class="custom-2">#ffffff</span>;
    <span class="org-css-property">background-color</span>: <span class="custom-1">#38ad3d</span>;
}
<span class="org-css-selector">.codex-caption-parent-link a:hover </span>{
    <span class="org-css-property">background-color</span>: <span class="custom">#389ffd</span>;
    <span class="org-css-property">text-decoration</span>: none;
}

<span class="org-css-selector">.codex-caption-link-symbol a </span>{
    <span class="org-css-property">margin-right</span>: 5px;
}
<span class="org-css-selector">.codex-caption-link-symbol a:hover </span>{
    <span class="org-css-property">text-decoration</span>: none;
}

<span class="org-css-selector">.codex-caption-listing-number </span>{
    <span class="org-css-property">margin-right</span>: 5px;
}
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-style-css--code">css-source-code-block-captions</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__css-source-code-block-captions">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Links-to-child-source-block-from-parent" class="outline-5">
<h5 id="h-Links-to-child-source-block-from-parent"><span class="section-number-5">3.2.2.3.</span> Links to child source block from parent</h5>
<div class="outline-text-5" id="text-h-Links-to-child-source-block-from-parent">
<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-css" id="__NREF__css-source-code-block-child-link-from-parent"><span class="org-css-selector">.codex-child-link-from-parent </span>{
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">font-weight</span>: bold;
}
<span class="org-css-selector">.codex-child-link-from-parent a </span>{
    <span class="org-css-property">padding-left</span>: 5px;
    <span class="org-css-property">padding-right</span>: 5px;
    <span class="org-css-property">padding-top</span>: 2px;
    <span class="org-css-property">padding-bottom</span>: 2px;
    <span class="org-css-property">color</span>: <span class="custom-2">#ffffff</span>;
    <span class="org-css-property">background-color</span>: <span class="custom-1">#389ffd</span>;
}
<span class="org-css-selector">.codex-child-link-from-parent a:hover </span>{
    <span class="org-css-property">background-color</span>: <span class="custom">#38ad3d</span>;
    <span class="org-css-property">text-decoration</span>: none;
}
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-style-css--code">css-source-code-block-child-link-from-parent</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__css-source-code-block-child-link-from-parent">&#x1f517;</a></span></div></div>
</div>
</div>
</div>

<div id="outline-container-h-Diagrams" class="outline-4">
<h4 id="h-Diagrams"><span class="section-number-4">3.2.3.</span> Diagrams</h4>
<div class="outline-text-4" id="text-h-Diagrams">
<p>
The code used to generate the diagrams used in this doc is <a href="image.html">here</a>. We don't discuss that code in this doc because it would make this doc even more verbose.
</p>
</div>
</div>

<div id="outline-container-h-Ignore-woven-HTML-from--git-diff" class="outline-4">
<h4 id="h-Ignore-woven-HTML-from--git-diff"><span class="section-number-4">3.2.4.</span> Ignore woven HTML from <code>git diff</code></h4>
<div class="outline-text-4" id="text-h-Ignore-woven-HTML-from--git-diff">
<p>
Typically we only need to look at the rendered HTML output in a web browser as the raw HTML diff output is extremely difficult to parse as a human. So by default we ask Git to exclude it from <code>git diff</code> by treating them as binary data.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-gitattributes">* -diff
**/*.org diff
**/.gitattributes diff
**/.gitmodules diff
**/.gitignore diff
</pre></div><div class="codex-caption"></div></div><p>
In order to still show the HTML textual diff, we can run <code>git diff --text</code>.
</p>
</div>

<div id="outline-container-h-git-add--p" class="outline-5">
<h5 id="h-git-add--p"><span class="section-number-5">3.2.4.1.</span> <code>git add -p</code></h5>
<div class="outline-text-5" id="text-h-git-add--p">
<p>
Note that the above setting to treat HTML files as binary data prevents them from being considered for <code>git add -p</code>. In order to add them, use <code>git add -u</code> instead.
</p>
</div>
</div>
</div>

<div id="outline-container-h-gitignore" class="outline-4">
<h4 id="h-gitignore"><span class="section-number-4">3.2.5.</span> gitignore</h4>
<div class="outline-text-4" id="text-h-gitignore">
<div class="org-src-container"><pre class="src src-gitignore">**/__pycache__
**/*.auctex-auto
**/*.hypothesis
tangle
weave
</pre></div>
</div>
</div>
</div>

<div id="outline-container-h-Tangling--generating-the-source-code" class="outline-3">
<h3 id="h-Tangling--generating-the-source-code"><span class="section-number-3">3.3.</span> Tangling (generating the source code)</h3>
<div class="outline-text-3" id="text-h-Tangling--generating-the-source-code">
<p>
Tangling is simply the act of collecting the <code>#+begin_src ... #+end_src</code> blocks and arranging them into the various target (source code) files. Every source code block is given a unique name.
</p>

<p>
We simply tangle all major <code>*.org</code> files in the toplevel Makefile.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-makefile" id="__NREF__Makefile-tangle"><span class="org-comment-delimiter"># </span><span class="org-comment">Currently we don't have any optimizations for tangling, but we still set CODEX_LP_QUICK=1 anyway to align with what we do for weave-quick.</span>
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">all_tangled_sources</span></span><span class="org-makefile-targets">) tangle &amp;</span>: $(<span class="org-variable-name">src</span>)
        <span class="org-type">@</span><span class="org-makefile-shell">echo tangling in parallel</span>
        <span class="org-variable-name">CODEX_LP_QUICK</span>=1 make -C $(<span class="org-variable-name">PROJ_ROOT</span>) -j$(<span class="org-variable-name">PROCS</span>) $(<span class="org-variable-name">all_tangled_sources</span>)
        touch tangle

<span class="org-variable-name">build_literate_org_output</span> = codex.el .gitattributes .gitignore Makefile shell.nix style.css syntax-highlighting.css
<span class="org-variable-name">all_tangled_sources</span> = citations.bib $(<span class="org-variable-name">build_literate_org_output</span>) $(<span class="org-variable-name">foreach</span> p,$(<span class="org-variable-name">problem_dirs_without_prefix</span>),problem/$(<span class="org-variable-name">p</span>)/__init__.py problem/$(<span class="org-variable-name">p</span>)/test_$(<span class="org-variable-name">p</span>).py)

<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">build_literate_org_output</span></span><span class="org-makefile-targets">) &amp;</span>: build-literate.org
<span class="org-makefile-space">        #</span><span class="org-comment-delimiter"> </span><span class="org-comment">Generate the toplevel Makefile (this file) and image/Makefile (overwriting</span>
<span class="org-makefile-space">        #</span><span class="org-comment-delimiter"> </span><span class="org-comment">them if necessary). In a way this bootstraps the whole</span>
<span class="org-makefile-space">        #</span><span class="org-comment-delimiter"> </span><span class="org-comment">literate-programming pipeline. Note that these files are different than</span>
<span class="org-makefile-space">        #</span><span class="org-comment-delimiter"> </span><span class="org-comment">the ones used to compile the tangled source code.</span>
        $(<span class="org-variable-name">call</span> run_emacs,(org-babel-tangle),build-literate.org)

<span class="org-makefile-targets">citations.bib</span>: README.org
        $(<span class="org-variable-name">call</span> run_emacs,(org-babel-tangle),README.org)

define tangle_tests

<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">1</span></span><span class="org-makefile-targets">) $(</span><span class="org-variable-name"><span class="org-makefile-targets">2</span></span><span class="org-makefile-targets">) &amp;</span>: $(<span class="org-variable-name">3</span>)
        <span class="org-type">@</span><span class="org-makefile-shell">echo tangling $(</span><span class="org-makefile-shell"><span class="org-variable-name">3</span></span><span class="org-makefile-shell">)</span>
        $(<span class="org-variable-name">call</span> run_emacs,(org-babel-tangle),$(<span class="org-variable-name">3</span>))

endef

<span class="org-comment-delimiter"># </span><span class="org-comment">See https://stackoverflow.com/a/9694782/437583.</span>
$(<span class="org-variable-name">foreach</span> p,$(<span class="org-variable-name">problem_dirs_without_prefix</span>),$(<span class="org-variable-name">eval</span> $(<span class="org-variable-name">call</span> tangle_tests,problem/$(<span class="org-variable-name">p</span>)/__init__.py,problem/$(<span class="org-variable-name">p</span>)/test_$(<span class="org-variable-name">p</span>).py,problem/$(<span class="org-variable-name">p</span>)/README.org)))
</pre></div><div class="codex-caption"><span class="codex-caption-parent-link"><a href="#code-Makefile--code">Makefile-tangle</a></span><span class="codex-caption-link-symbol"><a href="#__NREF__Makefile-tangle">&#x1f517;</a></span></div></div>
</div>
</div>

<div id="outline-container-h-Development-environment--Nix-shell" class="outline-3">
<h3 id="h-Development-environment--Nix-shell"><span class="section-number-3">3.4.</span> Development environment (Nix shell)</h3>
<div class="outline-text-3" id="text-h-Development-environment--Nix-shell">
<p>
This is taken from <a href="https://github.com/tweag/haskell-stack-nix-example/blob/b9383e35416a2b0e21fbc97ed079538f9f395b6a/shell.nix#L1">https://github.com/tweag/haskell-stack-nix-example/blob/b9383e35416a2b0e21fbc97ed079538f9f395b6a/shell.nix#L1</a>.
</p>

<p>
Note that we first have to do <code>nix-shell --pure</code> in Mool's toplevel directory, then <code>cd</code> into <code>moolc</code> and only from here we are able to do <code>stack exec -- ghci</code> to see the right version of GHC.
</p>

<p>
This is the main development shell and brings in all of our dependencies to build all of our code. It's great for development and testing things out (e.g., running unit tests) for all of the various languages we use.
</p>

<div class="org-src-container"><div class="codex-pre-with-caption"><pre class="src src-nix" id="code-shell-nix--code"><span class="org-nix-keyword">let</span>
  <span class="org-comment"># Nixpkgs snapshot.</span>
  <span class="org-nix-attribute">sources</span> = <span class="org-nix-builtin">import</span> <span class="org-nix-constant">./package/nix/sources.nix</span>;
  <span class="org-comment"># The final "pkgs" attribute with all the bells and whistles of our overlays.</span>
  <span class="org-nix-attribute">pkgs</span> = <span class="org-nix-builtin">import</span> sources.nixpkgs {};
<span class="org-nix-keyword">in</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">This is our development shell.</span>
pkgs.mkShell ({
  <span class="org-nix-attribute">buildInputs</span> = [
    <span class="org-comment"># Tangling and weaving for Literate Programming.</span>
    pkgs.emacs
    pkgs.inkscape
    pkgs.pdf2svg

    <span class="org-comment"># Misc</span>
    pkgs.git
    pkgs.less

    pkgs.python39Packages.hypothesis
  ];
})
</pre></div><div class="codex-caption"></div></div>
</div>
</div>

<div id="outline-container-h-Glossary" class="outline-3">
<h3 id="h-Glossary"><span class="section-number-3">3.5.</span> Glossary</h3>
<div class="outline-text-3" id="text-h-Glossary">
<ul class="org-ul">
<li><a id="org0000000"></a> <b>monoblock</b>: an Org mode source code block with a <code>#+name: ...</code> field. This block is an independent block and there are no other blocks with the same name.</li>
<li><b>Noweb</b>: A literate programming tool from 1989 that still works and from which <a href="#org000005a">Org mode</a> borrows heavily using <a href="#org000005c">Noweb-style references</a>. See <a href="https://en.wikipedia.org/wiki/Noweb">Wikipedia</a>.</li>
<li><a id="org000005c"></a> <b>noweb-ref</b>: aka "Noweb-style reference". A Noweb-style reference is just a name (string) that refers to a monoblock or polyblock. See <a href="https://orgmode.org/manual/Noweb-Reference-Syntax.html">the Org manual</a>.</li>
<li><a id="org000005a"></a> <b>Org mode</b>: An Emacs major mode for <code>*.org</code> files, where "major mode" means that it provides things like syntax highlighting and keyboard shortcuts for <code>*.org</code> text files if you are using Emacs. For Codex, the important thing is that we use Org mode as a literate programming tool. See <a href="https://orgmode.org/">Org mode</a>.</li>
<li><a id="org0000002"></a> <b>polyblock</b>: an Org mode source code block without a <code>#+name: ...</code> field, but which has a <code>#+header: :noweb-ref ...</code> field. Other blocks with the same noweb-ref name are concatenated together when they are tangled. Polyblocks are used in cases where we would like to break up a single block into much smaller pieces for explanatory purposes. In all other cases, monoblocks are preferable, unless the source code block is not to be tangled and is only for explanatory purposes in the woven output.</li>
<li><b>source code block</b>: An Org mode facility that allows you to enclose a multiline piece of text with <code>#+begin_src ...</code> and <code>#+end_src</code> lines.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-h-References" class="outline-2">
<h2 id="h-References"><span class="section-number-2">4.</span> References</h2>
<div class="outline-text-2" id="text-h-References">
<style>.csl-left-margin{float: left; padding-right: 1em;}
 .csl-right-inline{margin: 0 0 0 1em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>
    <div class="csl-left-margin">[1]</div><div class="csl-right-inline">A. Aziz, T.-H. Lee, and A. Prakash, <i>Elements of programming interviews in python: The insiders guide</i>. CreateSpace Independent Publishing Platform (15 Sept. 2016), 2016.</div>
  </div>
  <div class="csl-entry"><a id="citeproc_bib_item_2"></a>
    <div class="csl-left-margin">[2]</div><div class="csl-right-inline">H. S. Warren, <i>Hackers delight</i>, 2nd ed. Upper Saddle River, NJ: Addison-Wesley, 2013.</div>
  </div>
</div>
</div>
</div>
</div>
</body>
</html>
